#!/usr/bin/env bash

GH_REPO="https://github.com/eduardopoleoflipp/eduardo-foo"
TOOL_NAME="eduardo-foo"
TEST_COMMAND="foo"

set -euo pipefail

current_script_path=${BASH_SOURCE[0]}
plugin_dir=$(dirname "$(dirname "$current_script_path")")

mkdir -p "$ASDF_DOWNLOAD_PATH"

# Determine OS and architecture
os=""
arch=""

case "$(uname -s)" in
  Darwin) os="darwin" ;;
  Linux) os="linux" ;;
  MINGW*|MSYS*|CYGWIN*) os="windows" ;;
  *) fail "Unsupported operating system: $(uname -s)" ;;
esac

case "$(uname -m)" in
  x86_64) arch="amd64" ;;
  arm64|aarch64) arch="arm64" ;;
  i*86) arch="386" ;;
  *) fail "Unsupported architecture: $(uname -m)" ;;
esac

# Main location vars
release_file="${TOOL_NAME}_${ASDF_INSTALL_VERSION}_${os}_${arch}.tar.gz"
download_path="$ASDF_DOWNLOAD_PATH/$release_file"
url="$GH_REPO/releases/download/v${ASDF_INSTALL_VERSION}/$release_file"

echo "Debugging vars:"
echo "* ASDF_DOWNLOAD_PATH: $ASDF_DOWNLOAD_PATH" 
echo "* ASDF_INSTALL_VERSION: $ASDF_INSTALL_VERSION" 
echo "* release_file $release_file"
echo "* download_path $download_path"
echo "* url $url"

curl -fsSL -L -o "$download_path" "$url" || fail "Could not download $url"

if [ -f "$download_path" ]; then
  echo "* Download successful: $(ls -lh "$download_path")"
else
  fail "Download seems to have failed. File not found at $download_path"
fi

# Extract contents of tar.gz file into the download directory
echo "####About to extract####"
tar -xzf "$download_path" -C "$ASDF_DOWNLOAD_PATH" || fail "Could not extract $release_file"

# Remove the tar.gz file since we don't need to keep it
rm "$download_path"

echo "About to install"

echo "ASDF_INSTALL_VERSION: $ASDF_INSTALL_VERSION"
echo "ASDF_INSTALL_PATH: $ASDF_INSTALL_PATH"

mkdir -p "$ASDF_INSTALL_PATH/bin"

install_path="$ASDF_INSTALL_PATH/bin"

cp "$ASDF_DOWNLOAD_PATH/$TOOL_NAME" $install_path

test -x "$install_path $TOOL_NAME $TEST_COMMAND" || fail "Expected blah to be executable."

exit 1
